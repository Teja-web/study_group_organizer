pipeline {
  agent any
  options { 
    timestamps()
    timeout(time: 15, unit: 'MINUTES')
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  environment {
    NODE_VERSION = '18'
  }

  stages {
    /* 1) Checkout and Environment Setup */
    stage('Checkout & Setup') {
      steps {
        echo "=========================================="
        echo "üöÄ STARTING BUILD FOR STUDY GROUP ORGANIZER"
        echo "=========================================="
        echo "NODE = ${env.NODE_NAME}"
        echo "WORKSPACE = ${env.WORKSPACE}"
        echo "BUILD_NUMBER = ${env.BUILD_NUMBER}"
        echo "BRANCH = ${env.BRANCH_NAME}"
        echo "=========================================="
        
        script {
          if (isUnix()) {
            sh '''
              echo "üîç Checking Node.js version..."
              node --version
              echo "üîç Checking npm version..."
              npm --version
            '''
          } else {
            bat '''
              echo üîç Checking Node.js version...
              node --version
              echo üîç Checking npm version...
              npm --version
            '''
          }
        }
      }
    }

    /* 2) Install Dependencies */
    stage('Install Dependencies') {
      steps {
        echo "=========================================="
        echo "üì¶ INSTALLING DEPENDENCIES"
        echo "=========================================="
        
        script {
          if (isUnix()) {
            sh '''
              echo "üßπ Cleaning previous installations..."
              rm -rf node_modules package-lock.json
              echo "üì• Installing dependencies..."
              npm install
              echo "‚úÖ Dependencies installed successfully!"
            '''
          } else {
            bat '''
              echo üßπ Cleaning previous installations...
              if exist node_modules rmdir /s /q node_modules
              if exist package-lock.json del package-lock.json
              echo üì• Installing dependencies...
              npm install
              echo ‚úÖ Dependencies installed successfully!
            '''
          }
        }
      }
    }

    /* 3) Lint Code */
    stage('Code Linting') {
      steps {
        echo "=========================================="
        echo "üîç RUNNING CODE LINTING"
        echo "=========================================="
        
        script {
          if (isUnix()) {
            sh '''
              echo "üîç Running ESLint..."
              npm run lint
              echo "‚úÖ Code linting completed!"
            '''
          } else {
            bat '''
              echo üîç Running ESLint...
              npm run lint
              echo ‚úÖ Code linting completed!
            '''
          }
        }
      }
    }

    /* 4) Build React App */
    stage('Build React App') {
      steps {
        echo "=========================================="
        echo "üèóÔ∏è  BUILDING REACT APPLICATION"
        echo "=========================================="
        
        script {
          if (isUnix()) {
            sh '''
              echo "üßπ Cleaning previous build..."
              rm -rf dist
              echo "üèóÔ∏è  Building React App with Vite..."
              npm run build
              echo "‚úÖ Build completed successfully!"
              echo "üìÅ Build artifacts:"
              ls -la dist/
            '''
          } else {
            bat '''
              echo üßπ Cleaning previous build...
              if exist dist rmdir /s /q dist
              echo üèóÔ∏è  Building React App with Vite...
              npm run build
              echo ‚úÖ Build completed successfully!
              echo üìÅ Build artifacts:
              dir dist
            '''
          }
        }
      }
    }

    /* 5) Verify Build */
    stage('Verify Build') {
      steps {
        echo "=========================================="
        echo "üîç VERIFYING BUILD OUTPUT"
        echo "=========================================="
        
        script {
          if (isUnix()) {
            sh '''
              if [ -d "dist" ]; then
                echo "‚úÖ Build directory exists!"
                echo "üìä Build size:"
                du -sh dist/
                echo "üìÑ Build contents:"
                find dist -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10
                echo "üéâ BUILD VERIFICATION SUCCESSFUL!"
              else
                echo "‚ùå Build directory not found!"
                exit 1
              fi
            '''
          } else {
            bat '''
              if exist dist (
                echo ‚úÖ Build directory exists!
                echo üìä Build contents:
                dir dist /s
                echo üéâ BUILD VERIFICATION SUCCESSFUL!
              ) else (
                echo ‚ùå Build directory not found!
                exit /b 1
              )
            '''
          }
        }
      }
    }
  }

  post {
    success {
      echo "=========================================="
      echo "üéâ BUILD COMPLETED SUCCESSFULLY!"
      echo "=========================================="
      echo "Build Number: ${env.BUILD_NUMBER}"
      echo "Branch: ${env.BRANCH_NAME}"
      echo "Node: ${env.NODE_NAME}"
      echo "Duration: ${currentBuild.durationString}"
      echo "=========================================="
    }
    
    failure {
      echo "=========================================="
      echo "‚ùå BUILD FAILED!"
      echo "=========================================="
      echo "Build Number: ${env.BUILD_NUMBER}"
      echo "Branch: ${env.BRANCH_NAME}"
      echo "Node: ${env.NODE_NAME}"
      echo "Duration: ${currentBuild.durationString}"
      echo "Check the logs above for error details."
      echo "=========================================="
    }
    
    always {
      echo "=========================================="
      echo "üìã BUILD SUMMARY"
      echo "=========================================="
      echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
      echo "Build Number: ${env.BUILD_NUMBER}"
      echo "Duration: ${currentBuild.durationString}"
      echo "=========================================="
      
      // Archive build artifacts
      script {
        if (fileExists('dist')) {
          echo "üì¶ Archiving build artifacts..."
          if (isUnix()) {
            sh 'tar -czf build-artifacts.tar.gz dist/'
            archiveArtifacts artifacts: 'build-artifacts.tar.gz', allowEmptyArchive: false
          } else {
            archiveArtifacts artifacts: 'dist/**/*', allowEmptyArchive: false
          }
          echo "‚úÖ Artifacts archived successfully!"
        } else {
          echo "‚ö†Ô∏è  No build artifacts to archive"
        }
      }
    }
  }
}
