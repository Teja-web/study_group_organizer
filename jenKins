pipeline {
  agent none
  options { timestamps(); timeout(time: 15, unit: 'MINUTES') }

  stages {
    /* 1) Run basic info on the Jenkins Controller (built-in node) */
    stage('Where am I (Controller)') {
      agent { label 'built-in' }
      steps {
        echo "NODE = ${env.NODE_NAME}"
        echo "WORKSPACE = ${env.WORKSPACE}"
      }
    }

    /* 2) Install dependencies and Build React app on Windows Agent */
    stage('Build React App on Windows Agent') {
      agent { label 'win' }
      steps {
        bat """
        echo Installing dependencies...
        npm install
        echo Building React App...
        npm run build
        """
      }
    }

    /* 3) Run React tests on Windows Agent */
    stage('Run Tests on Windows Agent') {
      agent { label 'win' }
      steps {
        bat """
        echo Running Tests...
        npm test -- --watchAll=false
        """
      }
    }

    /* 4) Parallel demo on Controller and Windows Agent */
    stage('Parallel: Controller vs Agent') {
      parallel {
        stage('Controller lane') {
          agent { label 'built-in' }
          steps {
            echo "PARALLEL NODE = ${env.NODE_NAME}"
          }
        }
        stage('Agent lane') {
          agent { label 'win' }
          steps {
            bat "echo PARALLEL NODE = %NODE_NAME%"
          }
        }
      }
    }
  }

  post {
    always {
      node('win') {
        archiveArtifacts artifacts: 'build/**, **/test-results/**/*.xml', allowEmptyArchive: true
      }
    }
  }
}
